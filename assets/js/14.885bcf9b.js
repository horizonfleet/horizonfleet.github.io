(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{433:function(e,t,a){"use strict";a.r(t);var o=a(53),s=Object(o.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"deployment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deployment"}},[e._v("#")]),e._v(" Deployment")]),e._v(" "),a("p",[e._v("The Horizon fleet management system is deployed by containerizing all subcomponents and running them orchestrated by kubernetes in a cluster.\nApart from the batch database, which is hosted outside the cluster to achieve location independence, all components can be shut down and replaced dynamically. Following is a description of how to set up horizon yourself.\nAll files and sources reference the official public "),a("a",{attrs:{href:"https://github.com/horizonfleet/Horizon",target:"_blank",rel:"noopener noreferrer"}},[e._v("Horizon GitHub repository"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("h2",{attrs:{id:"azure"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#azure"}},[e._v("#")]),e._v(" Azure")]),e._v(" "),a("p",[e._v("Horizon requires three main components to execute:")]),e._v(" "),a("ul",[a("li",[e._v("A document-based batch-database")]),e._v(" "),a("li",[e._v("A blob storage / cloud drive for file exchange")]),e._v(" "),a("li",[e._v("A kubernetes cluster")])]),e._v(" "),a("p",[e._v("In addition, it is advisable to use a private container registry for the docker images.")]),e._v(" "),a("p",[e._v("Horizon FMS has been tested using services by Microsoft Azure in July 2020, but can be customized to work with any other cloud provider that offers services similar to the above-mentioned. The resources used were:")]),e._v(" "),a("ul",[a("li",[e._v("Azure Cosmos DB (Free tier with 400 RU/s is sufficient)")]),e._v(" "),a("li",[e._v("Azure blob storage container")]),e._v(" "),a("li",[e._v("One Azure Kubernetes Service (AKS) D2s v2 and D2s v3 instance")]),e._v(" "),a("li",[e._v("Azure container registry (10 GB are enough)")])]),e._v(" "),a("p",[e._v("The speed and batch layer both require access to the batch-database and blob storage container to work. Fleetsim comes with its own database hosted inside the cluster.")]),e._v(" "),a("p",[e._v('Access keys to both the cosmos db ("mongoConnectionString") as well as the blob storage  ("storageConnectionString") have to be present as text files (without ".txt"-ending) inside the speed- and batch-layer folders from which the docker images are built. If live weather enrichment is desired, a file with at least one (more are recommended in separate lines per key) openWeatherMap access keys should be present inside the speed-layer folder as well.')]),e._v(" "),a("h2",{attrs:{id:"building-docker-images"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#building-docker-images"}},[e._v("#")]),e._v(" Building docker images")]),e._v(" "),a("p",[e._v("Horizon FMS makes use of 8 docker images:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Function")]),e._v(" "),a("th",[e._v("Image name")]),e._v(" "),a("th",[e._v("Source")]),e._v(" "),a("th",[e._v("Folder")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("Zookeeper")]),e._v(" "),a("td",[e._v("zookeeper")]),e._v(" "),a("td",[e._v("dockerhub/library/zookeeper:3.4.14")]),e._v(" "),a("td",[e._v("-")])]),e._v(" "),a("tr",[a("td",[e._v("Kafka-Server")]),e._v(" "),a("td",[e._v("kafka")]),e._v(" "),a("td",[e._v("dockerhub/wurstmeister/kafka:2.11")]),e._v(" "),a("td",[e._v("-")])]),e._v(" "),a("tr",[a("td",[e._v("Fleetsim")]),e._v(" "),a("td",[e._v("fleetsim")]),e._v(" "),a("td",[e._v("Custom build")]),e._v(" "),a("td",[e._v("Data_Source>trucksimulation-master")])]),e._v(" "),a("tr",[a("td",[e._v("Fleetsim mongo-db")]),e._v(" "),a("td",[e._v("mongosim")]),e._v(" "),a("td",[e._v("Custom build")]),e._v(" "),a("td",[e._v("Data_Source>mongo")])]),e._v(" "),a("tr",[a("td",[e._v("Speed-Layer")]),e._v(" "),a("td",[e._v("speedlayer")]),e._v(" "),a("td",[e._v("Custom build")]),e._v(" "),a("td",[e._v("Backend>speed-layer")])]),e._v(" "),a("tr",[a("td",[e._v("Batch-Layer")]),e._v(" "),a("td",[e._v("batchlayer")]),e._v(" "),a("td",[e._v("Custom build")]),e._v(" "),a("td",[e._v("Backend>batch-layer")])]),e._v(" "),a("tr",[a("td",[e._v("Frontend-API")]),e._v(" "),a("td",[e._v("api")]),e._v(" "),a("td",[e._v("Custom build")]),e._v(" "),a("td",[e._v("Frontend>api")])]),e._v(" "),a("tr",[a("td",[e._v("Frontend")]),e._v(" "),a("td",[e._v("react")]),e._v(" "),a("td",[e._v("Custom build")]),e._v(" "),a("td",[e._v("Frontend>react")])])])]),e._v(" "),a("p",[e._v("In every folder, make sure all additional files that are needed are present (API Keys, mongo data folder) and run")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("docker build --tag <image_name> .\n")])])]),a("p",[e._v("if you use a container registry, upload the built image:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("docker push <image_name>\n")])])]),a("p",[e._v('The fleetsim mongo-db image requires a copy of a local mongo database "data" folder to run correctly. These files are obtained by running the fleetsim bootstrapper and simulation once on a local machine and precomputing the route information as well as truck master data and then copying the entire data folder of the local mongo-db into the fleetsim mongo folder. Unfortunately, there is no easier way to achieve a persistent and consistent mongo-db image with preexisting data.')]),e._v(" "),a("p",[e._v("In addition, when first setting up the cluster it is advisable to create dummy consumers that simply consume a kafka topic and print its contents to the console in order to monitor kafka topics and evaluate if some services may not work as intended.")]),e._v(" "),a("h2",{attrs:{id:"kubernetes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes"}},[e._v("#")]),e._v(" Kubernetes")]),e._v(" "),a("p",[e._v("A kubernetes cluster with a minimum of 6GB of RAM needs to be accessible. Lower memory will result in eviction of pods or unscheduled restarts/crashes due to memory pressure. Normally, this leads to a short downtime of the frontend or another service, in the worst case this results in the loss of data, creation of inconsistencies, or the full stop of the simulation (which has to be started manually).")]),e._v(" "),a("p",[e._v("The cluster should be deployed in the following order using the command")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("kubectl apply -f <filename>\n")])])]),a("p",[e._v("The filename refers to a yaml with the deployment specification for a specific pod or service, which can be found inside the Deployment>K8_Azure or Deployment>K8_Minikube folders, respectively. Inside these yamls, only the image name (or container registry + image name) and the pull rights secret have to be changed. For local deployment in minikube only change the image name to your locally built image.")]),e._v(" "),a("p",[e._v("Firstly, all services should be created. The services of frontend-api and frontend should not be altered afterwards as this changes their ip-adress.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("kubectl apply -f 01-zookeeper-service.yaml\nkubectl apply -f 03-mongo-service.yaml,04-simulation-service.yaml\nkubectl apply -f 06-api-service.yaml,07-react-service.yaml\n")])])]),a("p",[e._v("Secondly, deploy zookeeper and kafka before any other services that rely on these.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("kubectl apply -f 01-zookeeper-deployment.yaml,02-kafka-broker1-deployment.yaml  \n")])])]),a("p",[e._v("When first deploying, there is no data in the batch-database on which the batch-layer could run. Instead of deploying the speed-layer, batch-layer and all other components, deploy the lightspeed-layer instead and let it run for a while, ideally with the simulation set to a higher speed. Simulation speeds of 50x can be easily achieved with a message interval of 120 seconds.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("kubectl apply -f 03-mongo-deployment.yaml,04-simulation-deployment.yaml    \nkubectl apply -f 05-light-speed-deployment.yaml\n")])])]),a("p",[e._v("After the lightspeed-layer has run for some time and there are sufficient amounts of data for every route in the batch-database, shutdown the simulation and lightspeed-layer and first let the batch-layer run.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("kubectl delete -f 05-light-speed-deployment.yaml\nkubectl delete -f 03-mongo-deployment.yaml,04-simulation-deployment.yaml\nkubectl apply -f 05-batch-layer-deployment.yaml \nkubectl apply -f 05-batch-layer-cronjob.yaml \n")])])]),a("p",[e._v("The regular speed-layer along all other services can be deployed as soon as the batch-layer finishes (After the first time deploument, deploy the batch-layer along with the following components) :")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("kubectl apply -f 03-mongo-deployment.yaml,04-simulation-deployment.yaml    \nkubectl apply -f 05-spark-graph-deployment.yaml \nkubectl apply -f 06-api-deployment.yaml  \nkubectl apply -f 07-react-deployment.yaml\n")])])]),a("p",[e._v("Port forward the fleetsim pod on port 8080 and start the simulation in another console:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("kubectl get pods\nkubectl port-forward <fleetsim_pod_id> 8080:8080\n")])])]),a("p",[e._v("Start the simulation in another console:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v(" curl -X POST http://localhost:8080/api/v1/simulations/<simulation_name>/start\n")])])]),a("p",[e._v("To check which simulations are available and whether a simulation is running, port forward the fleetsim pod as above and run one of the two commands:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("curl -X GET http://localhost:8080/api/v1/simulations\ncurl -X GET http://localhost:8080/api/v1/simulations/<simulation_name>\n")])])]),a("p",[e._v("Now everything should be up and running. Run")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("kubectl get services\n")])])]),a("p",[e._v("to get the public pod ip-adress of the react-frontend and access the dashboard under port "),a("em",[e._v("3000")]),e._v(". Alternatively, port forward the react frontend and access the dashboard under "),a("em",[e._v("localhost:3000")]),e._v(" for local development.")]),e._v(" "),a("p",[e._v("To shutdown the cluster, delete all pods and services in reverse order. Optimally, also stop the simulation first:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("curl -X POST http://localhost:8080/api/v1/simulations/largeSim/stop\n\nkubectl delete -f 07-react-deployment.yaml\nkubectl delete -f 06-api-deployment.yaml\nkubectl delete -f 05-spark-graph-deployment.yaml\nkubectl delete -f 05-batch-layer-deployment.yaml\nkubectl delete -f 03-mongo-deployment.yaml,04-simulation-deployment.yaml\nkubectl delete -f 01-zookeeper-deployment.yaml,02-kafka-broker1-deployment.yaml\n")])])]),a("p",[e._v("and finally:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("kubectl delete -f 03-mongo-service.yaml,04-simulation-service.yaml\nkubectl delete -f 06-api-service.yaml,07-react-service.yaml\nkubectl delete -f 01-zookeeper-service.yaml\n")])])]),a("p",[e._v("The cluster can now shutdown safely.")]),e._v(" "),a("h3",{attrs:{id:"contact"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#contact"}},[e._v("#")]),e._v(" Contact")]),e._v(" "),a("p",[e._v("Contact "),a("a",{attrs:{href:"mailto:ja045@hdm-stuttgart.de"}},[e._v("Jan Anders")]),e._v(" if you require help deploying Horizon yourself.")])])}),[],!1,null,null,null);t.default=s.exports}}]);