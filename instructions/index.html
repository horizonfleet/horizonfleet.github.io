<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Instructions |  </title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content=" ">
    <link rel="preload" href="/assets/css/0.styles.dfb8af4c.css" as="style"><link rel="preload" href="/assets/js/app.22feb97a.js" as="script"><link rel="preload" href="/assets/js/2.8dbbb1b1.js" as="script"><link rel="preload" href="/assets/js/14.885bcf9b.js" as="script"><link rel="prefetch" href="/assets/js/10.3e66c877.js"><link rel="prefetch" href="/assets/js/11.a98f30c4.js"><link rel="prefetch" href="/assets/js/12.6db034f0.js"><link rel="prefetch" href="/assets/js/13.d4497414.js"><link rel="prefetch" href="/assets/js/15.0e728723.js"><link rel="prefetch" href="/assets/js/16.4c4c0653.js"><link rel="prefetch" href="/assets/js/17.a80c7ce7.js"><link rel="prefetch" href="/assets/js/3.32bfd81e.js"><link rel="prefetch" href="/assets/js/4.c7e0c83c.js"><link rel="prefetch" href="/assets/js/5.87965f52.js"><link rel="prefetch" href="/assets/js/6.9d3a15d7.js"><link rel="prefetch" href="/assets/js/7.773d2639.js"><link rel="prefetch" href="/assets/js/8.a3a2b8a3.js"><link rel="prefetch" href="/assets/js/9.031a4624.js">
    <link rel="stylesheet" href="/assets/css/0.styles.dfb8af4c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo_text.png" alt=" " class="logo"> <span class="site-name can-hide"> </span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/horizon/" class="nav-link">
  Horizon
</a></div><div class="nav-item"><a href="/process/" class="nav-link">
  Design Thinking
</a></div><div class="nav-item"><a href="/architecture/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="/datasource/" class="nav-link">
  Data Source
</a></div><div class="nav-item"><a href="/backend/" class="nav-link">
  Backend
</a></div><div class="nav-item"><a href="/frontend/" class="nav-link">
  Frontend
</a></div><div class="nav-item"><a href="/instructions/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  How to deploy
</a></div><div class="nav-item"><a href="/outlook/" class="nav-link">
  Outlook and Review
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/horizon/" class="nav-link">
  Horizon
</a></div><div class="nav-item"><a href="/process/" class="nav-link">
  Design Thinking
</a></div><div class="nav-item"><a href="/architecture/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="/datasource/" class="nav-link">
  Data Source
</a></div><div class="nav-item"><a href="/backend/" class="nav-link">
  Backend
</a></div><div class="nav-item"><a href="/frontend/" class="nav-link">
  Frontend
</a></div><div class="nav-item"><a href="/instructions/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  How to deploy
</a></div><div class="nav-item"><a href="/outlook/" class="nav-link">
  Outlook and Review
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Instructions</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/instructions/#azure" class="sidebar-link">Azure</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/instructions/#building-docker-images" class="sidebar-link">Building docker images</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/instructions/#kubernetes" class="sidebar-link">Kubernetes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/instructions/#contact" class="sidebar-link">Contact</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="deployment"><a href="#deployment" class="header-anchor">#</a> Deployment</h1> <p>The Horizon fleet management system is deployed by containerizing all subcomponents and running them orchestrated by kubernetes in a cluster.
Apart from the batch database, which is hosted outside the cluster to achieve location independence, all components can be shut down and replaced dynamically. Following is a description of how to set up horizon yourself.
All files and sources reference the official public <a href="https://github.com/horizonfleet/Horizon" target="_blank" rel="noopener noreferrer">Horizon GitHub repository<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="azure"><a href="#azure" class="header-anchor">#</a> Azure</h2> <p>Horizon requires three main components to execute:</p> <ul><li>A document-based batch-database</li> <li>A blob storage / cloud drive for file exchange</li> <li>A kubernetes cluster</li></ul> <p>In addition, it is advisable to use a private container registry for the docker images.</p> <p>Horizon FMS has been tested using services by Microsoft Azure in July 2020, but can be customized to work with any other cloud provider that offers services similar to the above-mentioned. The resources used were:</p> <ul><li>Azure Cosmos DB (Free tier with 400 RU/s is sufficient)</li> <li>Azure blob storage container</li> <li>One Azure Kubernetes Service (AKS) D2s v2 and D2s v3 instance</li> <li>Azure container registry (10 GB are enough)</li></ul> <p>The speed and batch layer both require access to the batch-database and blob storage container to work. Fleetsim comes with its own database hosted inside the cluster.</p> <p>Access keys to both the cosmos db (&quot;mongoConnectionString&quot;) as well as the blob storage  (&quot;storageConnectionString&quot;) have to be present as text files (without &quot;.txt&quot;-ending) inside the speed- and batch-layer folders from which the docker images are built. If live weather enrichment is desired, a file with at least one (more are recommended in separate lines per key) openWeatherMap access keys should be present inside the speed-layer folder as well.</p> <h2 id="building-docker-images"><a href="#building-docker-images" class="header-anchor">#</a> Building docker images</h2> <p>Horizon FMS makes use of 8 docker images:</p> <table><thead><tr><th>Function</th> <th>Image name</th> <th>Source</th> <th>Folder</th></tr></thead> <tbody><tr><td>Zookeeper</td> <td>zookeeper</td> <td>dockerhub/library/zookeeper:3.4.14</td> <td>-</td></tr> <tr><td>Kafka-Server</td> <td>kafka</td> <td>dockerhub/wurstmeister/kafka:2.11</td> <td>-</td></tr> <tr><td>Fleetsim</td> <td>fleetsim</td> <td>Custom build</td> <td>Data_Source&gt;trucksimulation-master</td></tr> <tr><td>Fleetsim mongo-db</td> <td>mongosim</td> <td>Custom build</td> <td>Data_Source&gt;mongo</td></tr> <tr><td>Speed-Layer</td> <td>speedlayer</td> <td>Custom build</td> <td>Backend&gt;speed-layer</td></tr> <tr><td>Batch-Layer</td> <td>batchlayer</td> <td>Custom build</td> <td>Backend&gt;batch-layer</td></tr> <tr><td>Frontend-API</td> <td>api</td> <td>Custom build</td> <td>Frontend&gt;api</td></tr> <tr><td>Frontend</td> <td>react</td> <td>Custom build</td> <td>Frontend&gt;react</td></tr></tbody></table> <p>In every folder, make sure all additional files that are needed are present (API Keys, mongo data folder) and run</p> <div class="language- extra-class"><pre><code>docker build --tag &lt;image_name&gt; .
</code></pre></div><p>if you use a container registry, upload the built image:</p> <div class="language- extra-class"><pre><code>docker push &lt;image_name&gt;
</code></pre></div><p>The fleetsim mongo-db image requires a copy of a local mongo database &quot;data&quot; folder to run correctly. These files are obtained by running the fleetsim bootstrapper and simulation once on a local machine and precomputing the route information as well as truck master data and then copying the entire data folder of the local mongo-db into the fleetsim mongo folder. Unfortunately, there is no easier way to achieve a persistent and consistent mongo-db image with preexisting data.</p> <p>In addition, when first setting up the cluster it is advisable to create dummy consumers that simply consume a kafka topic and print its contents to the console in order to monitor kafka topics and evaluate if some services may not work as intended.</p> <h2 id="kubernetes"><a href="#kubernetes" class="header-anchor">#</a> Kubernetes</h2> <p>A kubernetes cluster with a minimum of 6GB of RAM needs to be accessible. Lower memory will result in eviction of pods or unscheduled restarts/crashes due to memory pressure. Normally, this leads to a short downtime of the frontend or another service, in the worst case this results in the loss of data, creation of inconsistencies, or the full stop of the simulation (which has to be started manually).</p> <p>The cluster should be deployed in the following order using the command</p> <div class="language- extra-class"><pre><code>kubectl apply -f &lt;filename&gt;
</code></pre></div><p>The filename refers to a yaml with the deployment specification for a specific pod or service, which can be found inside the Deployment&gt;K8_Azure or Deployment&gt;K8_Minikube folders, respectively. Inside these yamls, only the image name (or container registry + image name) and the pull rights secret have to be changed. For local deployment in minikube only change the image name to your locally built image.</p> <p>Firstly, all services should be created. The services of frontend-api and frontend should not be altered afterwards as this changes their ip-adress.</p> <div class="language- extra-class"><pre><code>kubectl apply -f 01-zookeeper-service.yaml
kubectl apply -f 03-mongo-service.yaml,04-simulation-service.yaml
kubectl apply -f 06-api-service.yaml,07-react-service.yaml
</code></pre></div><p>Secondly, deploy zookeeper and kafka before any other services that rely on these.</p> <div class="language- extra-class"><pre><code>kubectl apply -f 01-zookeeper-deployment.yaml,02-kafka-broker1-deployment.yaml  
</code></pre></div><p>When first deploying, there is no data in the batch-database on which the batch-layer could run. Instead of deploying the speed-layer, batch-layer and all other components, deploy the lightspeed-layer instead and let it run for a while, ideally with the simulation set to a higher speed. Simulation speeds of 50x can be easily achieved with a message interval of 120 seconds.</p> <div class="language- extra-class"><pre><code>kubectl apply -f 03-mongo-deployment.yaml,04-simulation-deployment.yaml    
kubectl apply -f 05-light-speed-deployment.yaml
</code></pre></div><p>After the lightspeed-layer has run for some time and there are sufficient amounts of data for every route in the batch-database, shutdown the simulation and lightspeed-layer and first let the batch-layer run.</p> <div class="language- extra-class"><pre><code>kubectl delete -f 05-light-speed-deployment.yaml
kubectl delete -f 03-mongo-deployment.yaml,04-simulation-deployment.yaml
kubectl apply -f 05-batch-layer-deployment.yaml 
kubectl apply -f 05-batch-layer-cronjob.yaml 
</code></pre></div><p>The regular speed-layer along all other services can be deployed as soon as the batch-layer finishes (After the first time deploument, deploy the batch-layer along with the following components) :</p> <div class="language- extra-class"><pre><code>kubectl apply -f 03-mongo-deployment.yaml,04-simulation-deployment.yaml    
kubectl apply -f 05-spark-graph-deployment.yaml 
kubectl apply -f 06-api-deployment.yaml  
kubectl apply -f 07-react-deployment.yaml
</code></pre></div><p>Port forward the fleetsim pod on port 8080 and start the simulation in another console:</p> <div class="language- extra-class"><pre><code>kubectl get pods
kubectl port-forward &lt;fleetsim_pod_id&gt; 8080:8080
</code></pre></div><p>Start the simulation in another console:</p> <div class="language- extra-class"><pre><code> curl -X POST http://localhost:8080/api/v1/simulations/&lt;simulation_name&gt;/start
</code></pre></div><p>To check which simulations are available and whether a simulation is running, port forward the fleetsim pod as above and run one of the two commands:</p> <div class="language- extra-class"><pre><code>curl -X GET http://localhost:8080/api/v1/simulations
curl -X GET http://localhost:8080/api/v1/simulations/&lt;simulation_name&gt;
</code></pre></div><p>Now everything should be up and running. Run</p> <div class="language- extra-class"><pre><code>kubectl get services
</code></pre></div><p>to get the public pod ip-adress of the react-frontend and access the dashboard under port <em>3000</em>. Alternatively, port forward the react frontend and access the dashboard under <em>localhost:3000</em> for local development.</p> <p>To shutdown the cluster, delete all pods and services in reverse order. Optimally, also stop the simulation first:</p> <div class="language- extra-class"><pre><code>curl -X POST http://localhost:8080/api/v1/simulations/largeSim/stop

kubectl delete -f 07-react-deployment.yaml
kubectl delete -f 06-api-deployment.yaml
kubectl delete -f 05-spark-graph-deployment.yaml
kubectl delete -f 05-batch-layer-deployment.yaml
kubectl delete -f 03-mongo-deployment.yaml,04-simulation-deployment.yaml
kubectl delete -f 01-zookeeper-deployment.yaml,02-kafka-broker1-deployment.yaml
</code></pre></div><p>and finally:</p> <div class="language- extra-class"><pre><code>kubectl delete -f 03-mongo-service.yaml,04-simulation-service.yaml
kubectl delete -f 06-api-service.yaml,07-react-service.yaml
kubectl delete -f 01-zookeeper-service.yaml
</code></pre></div><p>The cluster can now shutdown safely.</p> <h3 id="contact"><a href="#contact" class="header-anchor">#</a> Contact</h3> <p>Contact <a href="mailto:ja045@hdm-stuttgart.de">Jan Anders</a> if you require help deploying Horizon yourself.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.22feb97a.js" defer></script><script src="/assets/js/2.8dbbb1b1.js" defer></script><script src="/assets/js/14.885bcf9b.js" defer></script>
  </body>
</html>
